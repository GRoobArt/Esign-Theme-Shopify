{%- doc -%}
  Renders a list or swatch filter.

  @param {object} filter - The filter to render
  @param {string} filter_style - The filter style ('horizontal' | 'vertical')
  @param {number} active_value_count - The number of active values
  @param {number} sectionId - The section ID
  @param {boolean} [autofocus] - Whether to autofocus the filter
  @param {boolean} [should_render_clear] - Whether to render the clear button
  @param {boolean} [show_swatch_label] - Whether to show the swatch label
  @param {boolean} [in_drawer] - Whether the filter is in a drawer
{%- enddoc -%}

{% liquid
  assign is_swatch = false
  assign swatch_index = filter.values | find_index: 'swatch'

  if swatch_index != null
    assign is_swatch = true
  endif

  assign is_image = false
  if filter.presentation == 'image'
    assign is_image = true
  endif
%}

{% liquid
  assign has_active_values = false
  assign inital_visible_values = 10
  if is_swatch
    assign inital_visible_values = 22
  endif
  if is_image
    assign inital_visible_values = 6
  endif
  assign max_visible_values = inital_visible_values | plus: 1
  assign render_show_more = false
  assign should_render_for_swatch = is_swatch
  if is_swatch and show_swatch_label
    assign should_render_for_swatch = false
  endif
  if filter.values.size > max_visible_values and should_render_for_swatch == false
    assign render_show_more = true
  endif
%}
<facet-inputs-component
  on:change="/updateFilters"
  id="facet-inputs-component-{{ filter.param_name | escape | replace: '.', '-' }}"
>
  {% liquid
    if render_show_more
      if filter_style == 'horizontal'
        echo '<show-more-component class="show-more" data-expanded="false" data-disable-on-desktop="true" data-skip-node-update="true">'
      else
        echo '<show-more-component class="show-more" data-expanded="false" data-skip-node-update="true">'
      endif
    endif
    assign should_use_pills = true

    for value in filter.values
      if value.label.size > 3
        assign should_use_pills = false
        break
      endif
    endfor

    if filter.type == 'boolean'
      assign should_use_pills = false
    endif
  %}
  <div
    class="facets__inputs-wrapper facets__inputs-wrapper--row"
    ref="showMoreContent"
  >
      {% liquid
        if is_swatch
          assign swatch_columns = filter.values.size

          if swatch_columns > 4
            assign swatch_columns = 4

            # Balance the number of columns based on the number of values, i.e. try to avoid one or two items in
            # the last row if the number of values is (almost) divisible by 3.
            assign mod4 = filter.values.size | modulo: 4
            assign mod3 = filter.values.size | modulo: 3
            if mod4 != 0 and mod4 != 3
              if mod3 == 0 or mod3 == 2
                assign swatch_columns = 3
              endif
            endif
          endif
        endif

        if is_image
          assign image_columns = 3
          if filter.values.size < 3
            assign image_columns = filter.values.size
          endif
        endif
      %}
      <ul
        id="filters-list-{{ sectionId }}-{{ filter.param_name | escape | replace: '.', '-' }}"
        class="facets__inputs-list{% if should_use_pills %} facets__inputs-list--grid{% endif %} list-unstyled{% if is_swatch %} facets__inputs-list--swatches{% if show_swatch_label %} facets__inputs-list--swatches-grid{% endif %}{% endif %}{% if is_image %} facets__inputs-list--images{% endif %}"
        {% if is_swatch %}
          style="--swatch-columns: {{ swatch_columns }};"
        {% endif %}
        {% if is_image %}
          style="--image-columns: {{ image_columns }};"
        {% endif %}
        name="{{ filter.label }}"
      >
        {% for value in filter.values %}
          {% liquid
            assign input_id = 'Filter-' | append: filter.param_name | escape | append: '-' | append: forloop.index | replace: '.', '-' | append: '-' | append: filter_style | append: '-' | append: in_drawer
            assign is_disabled = false
            if value.count == 0 and value.active == false
              assign is_disabled = true
            endif
            assign hidden_class = null
            if forloop.index > inital_visible_values and render_show_more
              assign hidden_class = 'hidden'
              if filter_style == 'horizontal'
                assign hidden_class = 'mobile:hidden'
              endif
            endif
          %}
          <li
            data-skip-node-update="true"
            class="facets__inputs-list-item{% if hidden_class %} {{ hidden_class }}{% endif %}"
            {% if hidden_class %}
              ref="showMoreItems[]"
            {% endif %}
          >
            <div
              class="facets__pill-wrapper"
              on:keydown="#facet-inputs-component-{{ filter.param_name | escape | replace: '.', '-' }}/handleKeyDown"
            >
              <input
                type="checkbox"
                name="{{ value.param_name }}"
                value="{{ value.value }}"
                id="{{ input_id }}"
                class="facets__pill-input"
                data-label="{{ value.label }}"
                {% if value.active %}
                  checked
                {% endif %}
                {% if is_disabled %}
                  disabled
                {% endif %}
                {% if autofocus %}
                  autofocus
                {% endif %}
                ref="facetInputs[]"
                tabindex="-1"
              >
              <label
                class="facets__pill-label"
                for="{{ input_id }}"
                tabindex="0"
              >
                {{ value.label }}
                {% if is_disabled %}
                  <svg
                    aria-hidden="true"
                    width="100%"
                    height="100%"
                    viewBox="0 0 100 100"
                    preserveAspectRatio="none"
                  >
                    <line x1="100" y1="0" x2="0" y2="100" vector-effect="non-scaling-stroke" />
                  </svg>
                {% endif %}
              </label>
            </div>
          </li>
        {% endfor %}
      </ul>
    </div>
    {% if render_show_more %}
      <button
        class="show-more__button button-unstyled button-unstyled--with-icon{% if filter_style == 'horizontal' %} desktop:hidden{% endif %}"
        ref="showMoreButton"
        on:click="/toggle"
        aria-expanded="false"
        aria-controls="filters-list-{{ sectionId }}-{{ filter.param_name | escape | replace: '.', '-' }}"
      >
        <span class="svg-wrapper icon-plus">
          {{- 'icon-plus.svg' | inline_asset_content -}}
        </span>
        <span class="show-more__label show-more__label--more">
          {{- 'actions.show_more' | t -}}
        </span>
        <span class="show-more__label show-more__label--less">
          {{- 'actions.show_less' | t -}}
        </span>
      </button>
      {% echo '</show-more-component>' %}
    {% endif %}
</facet-inputs-component>
